import Phaser from '../libs/phaser-wx.js';
import Class from "./class.js";
require("./wx");

var App = {};
var game, cmd, data, cookies, fader, stateSlider, parser, sounds, util;

function Config() {}
Config.RELEASE = !0, Config.SHOWTIER = !1;
Config.PIANO = !1, Config.VERSION = "0.99", Config.WIDTH = 640, Config.HEIGHT = 712, Config.FONT_LEVEL_SELECT_ID = "Arial", Config.FONT_GAMEPLAY_LEVEL_ID = "Titan One";
 Config.TOUCH_BOUNDS = {
    x: 0,
    y: 0,
    width: Config.WIDTH,
    height: Config.HEIGHT + 100
};
Config.BITMAP_LINES = !0, Config.USE_PARTICLES = !0, Config.ANIMATION = !0, Config.SOUNDS_ENABLED = !0, Config.TRANSPARENT = !1, Config.START_LEVEL = 0, Config.TEST_GAME_COMPLETE = !1, Config.SHOW_FPS = !0, Config.OPEN_ALL_LEVELS = !0, Config.DEBUG_PHYSICS = !1, Config.ENABLE_CHEAT = !0, Config.RELEASE && (Config.ANIMATION = !0, Config.SOUNDS_ENABLED = !0, Config.TRANSPARENT = !1, Config.START_LEVEL = 0, Config.TEST_GAME_COMPLETE = !1, Config.SHOW_FPS = !1, Config.OPEN_ALL_LEVELS = !1, Config.DEBUG_PHYSICS = !1, Config.ENABLE_CHEAT = !1);
Config.cdnUrl = 'https://uf2.zingfront.com/playable/wx/ybgx';
App.Parser = Class.extend({
    init: function () {},
    generateLevel: function (a, b, c) {
        this.game = a, this.parentGroup = b, this.game.add.sprite(0, -Config.offsetY, "background", 0, b), this.paper = new App.Paper(this.game, this.parentGroup);
        var d = c.id + 1,
            e = this.game.add.bitmapText(0, 0, "eras", d.toString(), 50, this.parentGroup);
        e.width = e.width * 1.2;
        e.height = e.height * 1.2;
        e.x = Config.WIDTH / 2 - .5 * e.textWidth * 1.2, e.y = Config.HEIGHT + (Config.levelY), this.linksGroup = new Phaser.Group(this.game, this.parentGroup), this.dotsGroup = new Phaser.Group(this.game, this.parentGroup), this.parseLevelData(c.data);
        var f = {
            dotsGroup: this.dotsGroup,
            linksGroup: this.linksGroup,
            dots: this.dots,
            staticLinks: this.staticLinks
        };
        return this.decorObj && this.paper.addDecor(this.decorObj.name, this.decorObj.x, this.decorObj.y), f;
    },
    parseLevelData: function (a) {
        this.dots = [], this.staticLinks = [];
        var b, c = a.v2,
            d = a.lines,
            e = a.decor,
            f = 6,
            g = 1;
        if (c)
            for (b = 0; b < c.length; b++) {
                var h = c[b],
                    i = h.id,
                    j = h.x,
                    k = h.y,
                    l = "dotBase" + g;
                if (data.curTier.id > 0) {
                    j += 55;
                    k += 60;
                }
                this.addDot(i, j, k, l), g++, g > f && (g = 1)
            }
        if (d)
            for (b = 0; b < d.length; b++) this.addStaticLink(d[b].start, d[b].end, d[b].arrow || d[b].lock);
        if (this.decorObj = null, e) {
            var m = e.name,
                n = e.x,
                o = e.y;
            this.decorObj = {
                name: m,
                x: n,
                y: o
            }
        }
    },
    addDot: function (a, b, c, d) {
        var e = new App.Dot(this.game, this.dotsGroup, a, b, c, d);
        this.dots.push(e)
    },
    addStaticLink: function (a, b, c) {
        var d = this.getDotById(a),
            e = this.getDotById(b),
            f = new App.StaticLink(this.game, this.linksGroup, d, e, c);
        this.staticLinks.push(f)
    },
    getDotById: function (a) {
        for (var b = 0; b < this.dots.length; b++) {
            var c = this.dots[b];
            if (c.id === a) return c
        }
        return null
    }
});
App.Sounds = Class.extend({
    init: function () {
        this.musicChannel = void 0
    },
    startMusic: function () {
        Config.SOUNDS_ENABLED && (this.musicChannel = game.add.audio("music", 1, !0), this.musicChannel.play());
    },
    stopMusic: function () {
        this.musicChannel && this.musicChannel.pause()
    },
    play: function (a, b) {
        var c = 1;
        void 0 != b && (c = b), Config.SOUNDS_ENABLED && game.sound.play(a, c)
    },
    startLevel: function () {
        this.pianoMin = 0, this.pianoMax = 23, this.pianoIndex = 2 + Math.floor(8 * Math.random()), this.pianoIncrement = 1
    },
    playPiano: function () {
        Config.SOUNDS_ENABLED && Config.PIANO && data.sndPiano.play("note" + this.pianoIndex), this.pianoIndex == this.pianoMin && (this.pianoIncrement = 1), this.pianoIndex == this.pianoMax && (this.pianoIncrement = -1), this.pianoIndex += this.pianoIncrement;
    }
});
App.Util = Class.extend({
    init: function () {},
    pulse: function (a, b) {
        void 0 == b && (b = 1.2), game.add.tween(a.scale).to({
            x: b,
            y: b
        }, 1e3, Phaser.Easing.Sinusoidal.InOut).to({
            x: 1,
            y: 1
        }, 1e3, Phaser.Easing.Sinusoidal.InOut).loop().start()
    },
    wobble: function (a, b) {
        void 0 == b && (b = 1);
        for (var c = game.add.tween(a.scale), d = 0; b > d; d++) {
            var c = c.to({
                x: 1.2,
                y: .8
            }, 100, Phaser.Easing.Sinusoidal.InOut);
            c.to({
                x: 1,
                y: 1
            }, 100, Phaser.Easing.Sinusoidal.InOut)
        }
        c.start()
    },
    formatTime: function (a) {
        var b = Math.floor(a / 1e3),
            c = Math.floor(b / 3600),
            d = Math.floor((b - 3600 * c) / 60),
            e = b - 3600 * c - 60 * d;
        return 10 > c && (c = "0" + c), 10 > d && (d = "0" + d), 10 > e && (e = "0" + e), d + ":" + e
    },
    randomizeArray: function (a) {
        for (var b = [], c = a.length; c--;) {
            var d = Math.floor(Math.random() * a.length),
                e = a.splice(d, 1)[0];
            b.unshift(e)
        }
        return b
    }
});
App.Commands = Class.extend({
    init: function () {},
    gameStart: function () {
        Config.TEST_GAME_COMPLETE ? this.gameComplete() : (cookies.info.isNewGame && !Config.SHOWTIER) ? this.playNewGame() : game.state.start("TierSelect");
    },
    playNewGame: function () {
        data.curTier = data.tiers[0];
        data.initLevels() && cookies.initLevels() && cmd.levelStart(Config.START_LEVEL);
    },
    tierSelect: function (a) {
        data.curTier = data.tiers[a], data.preloadNextTier(), game.state.start("LevelSelect");
    },
    levelStart: function (a) {
        data.preloadNextTier(), data.curLevel = data.levels[a], data.levelStartTime = game.time.now, data.pauseTime = 0, game.state.start("Gameplay");
    },
    levelComplete: function () {
        game.state.getCurrentState().levelComplete(), data.curLevel.complete(), cookies.levelComplete(), stateSlider.levelComplete();
    },
    tierComplete: function () {
        if (Config.SHOWTIER) {
            data.curTier.complete(), cookies.tierComplete(), game.state.start('TierSelect');
        } else {
            cmd.gameComplete();
        }
    },
    gameComplete: function () {
        fader.fade(this.doGameComplete, this);
    },
    doGameComplete: function () {
        game.state.start("GameComplete");
    },
    reloadTier: function () {
        weixin.downloadLevel(data.curTier.id, function () {
            data.curTier.loaded = true;
            game.state.start("LevelSelect");
        }, true);
    },
});
App.Cookies = Class.extend({
    init: function () {
        var info = weixin.getGameInfo();
        if (info) {
            this.info = info;
        } else {
            this.info = {
                isNewGame: true,
                maxTier: 0,
                maxLevel: 0,
                soundEnabled: false,
            };
        }
        this.initSound();
        this.initTiers();
    },
    initSound: function () {
        Config.SOUNDS_ENABLED = this.info.soundEnabled;
    },
    saveSound: function () {
        this.info.soundEnabled = Config.SOUNDS_ENABLED;
        this.save();
    },
    initLevels: function () {
        for (var a = 0; a < data.levels.length && a <= this.info.maxLevel; a++) {
            var b = data.levels[a];
            b.isOpen = !0, b.isCompleted = !0;
        }
        this.updateOpenLevels();
        return true;
    },
    updateOpenLevels: function () {
        var a, b;
        if (Config.OPEN_ALL_LEVELS)
            for (a = 0; a < data.levels.length; a++) b = data.levels[a], b.isOpen = !0;
        else
            for (a = 0; a < data.levels.length; a++)
                if (b = data.levels[a], !b.isCompleted) {
                    b.isOpen = !0;
                    break
                }
    },
    levelComplete: function () {
        var a = data.curLevel.id;
        a > this.info.maxLevel && (this.info.maxLevel = a), this.info.isNewGame = !1, this.updateOpenLevels();
        this.save();
    },
    clear: function () {
        this.info.maxLevel = 0, this.info.isNewGame = !0, this.save();
        this.uncompleteLevels(), this.updateOpenLevels();
    },
    uncompleteLevels: function () {
        for (var a = 0; a < data.levels.length; a++) {
            var b = data.levels[a];
            b.reset();
        }
    },
    save: function () {
        weixin.saveGameInfo(this.info);
    },
    initTiers: function () {
        for (var a = 0; a < data.tiers.length && a <= this.info.maxTier; a++) {
            var b = data.tiers[a];
            b.isOpen = !0, b.isCompleted = !0;
        }
        this.updateOpenTiers();
    },
    updateOpenTiers: function () {
        var a, b;
        if (Config.OPEN_ALL_LEVELS)
            for (a = 0; a < data.tiers.length; a++) b = data.tiers[a], b.isOpen = !0;
        else
            for (a = 0; a < data.tiers.length; a++)
                if (b = data.tiers[a], !b.isCompleted) {
                    b.isOpen = !0;
                    break
                }
    },
    tierComplete: function () {
        var a = data.curTier.id;
        this.info.maxTier = a, this.info.isNewGame = !1, this.updateOpenTiers();
        this.save();
    },
});
App.Data = Class.extend({
    init: function (a) {
        this.lang = a, this.texts = weixin.readFile('src/data/text.json'), this.curLevel = null, this.levelStartTime = 0, this.levelStartTime = 0, this.pauseTime = 0, this.pausedByUser = !1;
        this.atlasName = "pics";
        this.initTiers();
        if (Config.SOUNDS_ENABLED && Config.PIANO) {
            this.sndPiano = game.add.audio("sndPiano");
            for (var b = 0; 24 > b; b++) this.sndPiano.addMarker("note" + b, b, 1);
        }
    },
    getAtlasKey: function (a) {
        return this.atlasName + "/" + a + "_0000";
    },
    addAtlasSprite: function (a, b) {
        var c = 0,
            d = 0,
            e = game.world;
        return b && (void 0 != b.x && (c = b.x), void 0 != b.y && (d = b.y), void 0 != b.parent && (e = b.parent)), game.add.sprite(c, d, this.atlasName, this.getAtlasKey(a), e);
    },
    initLevels: function () {
        this.levels = [];
        var levelData = weixin.getLevelData(this.curTier.id);
        if (!levelData) {
            /* 数据错误，上传错误日志，提示网络错误，重新加载游戏 */
            cmd.reloadTier();
            return false;
        }
        levelData.forEach(element => {
            this.addLevel(element);
        });
        return true;
    },
    addLevel: function (a) {
        var b = this.levels.length,
            c = new App.Level(b, a);
        this.levels.push(c);
    },
    initTiers: function () {
        this.tiers = [];
        var levelData = weixin.readFile('src/data/tier.json');
        levelData.forEach(element => {
            this.addTier(element);
        });
        return true;
    },
    addTier: function (a) {
        var b = this.tiers.length,
            c = new App.Tier(b, a);
        this.tiers.push(c);
    },
    getLevelTime: function () {
        return Math.round(game.time.elapsedSince(this.levelStartTime) - data.pauseTime)
    },
    getTotalTime: function () {
        for (var a = 0, b = 0; b < data.levels.length; b++) {
            var c = data.levels[b];
            c.isCompleted && (a += c.bestTime);
        }
        return a;
    },
    preloadNextTier: function () {
        var id = this.curTier.id + 1;
        if (id > this.tiers.length || this.tiers[id].loaded) {
            return;
        }
        weixin.downloadLevel(id, function () {
            data.tiers[id].loaded = true;
        });
    }
});
App.Dialog = Class.extend({
    init: function (a, b, c) {
        this.game = a;
        var d = 0,
            e = 0,
            f = !1,
            g = !0;
        if (c && (void 0 != c.x && (d = c.x), void 0 != c.y && (e = c.y), 1 == c.blockBack && (f = !0), 0 == c.doTween && (g = !1)), this.holder = new Phaser.Group(this.game, this.game.world), f && (this.block = new Phaser.Sprite(this.game, 0, -Config.offsetY, "blackBack"), this.block.inputEnabled = !0, this.holder.add(this.block)), this.boxHolder = new Phaser.Group(this.game, this.holder), this.boxHolder.x = d, this.boxHolder.y = e, this.box = new Phaser.Sprite(this.game, 0, 0, b), this.boxHolder.add(this.box), g) {
            var h = this.boxHolder.y;
            this.boxHolder.y = Config.HEIGHT, this.game.add.tween(this.boxHolder).to({
                y: h
            }, 1e3, Phaser.Easing.Back.Out, !0), f && (this.block.alpha = 0, this.game.add.tween(this.block).to({
                alpha: 1
            }, 500, Phaser.Easing.Linear.None, !0))
        }
    },
    destroy: function () {
        this.holder.destroy()
    }
});
App.GameLogic = Class.extend({
    init: function (a, b, c, d, e, f) {
        this.game = a, this.parentGroup = b, this.dotsGroup = c, this.linksGroup = d, this.dots = e, this.staticLinks = f, this.drawLine = null, this.userLinks = [], this.game.input.onDown.add(this.touchDownHandler, this), this.game.input.onUp.add(this.touchUpHandler, this), sounds.startLevel(), this.game.world.setBounds(-Config.WIDTH, -Config.offsetY, 4 * Config.WIDTH, Config.HEIGHT), Config.USE_PARTICLES && (this.vfx = new App.VisualFX(this.game));
        game.anwsering && this.showAnwser();
    },
    addStaticLink: function (a, b, e) {
        var c = this.getDotById(a),
            d = this.getDotById(b),
            f = new App.StaticLink(this.game, this.linksGroup, c, d, e);
        this.staticLinks.push(f);
    },
    removeStaticLink: function (a) {
        var b = this.staticLinks.indexOf(a);
        this.staticLinks.splice(b, 1), a.destroy();
    },
    getDotById: function (a) {
        for (var b = 0; b < this.dots.length; b++) {
            var c = this.dots[b];
            if (c.id === a) return c;
        }
        return null
    },
    touchDownHandler: function (a) {
        game.startDraw = true;
        if (!game.anwsering && !data.pausedByUser && this.touchInsideBounds(a.x, a.y))
            if (this.drawLine) this.drawLine.startFollow();
            else {
                var b = Math.round(a.x),
                    c = Math.round(a.y),
                    d = this.getTapDotUnderPoint(b, c);
                d && (this.partyDot(d), this.startDrawingLine(d));
            }
    },
    partyDot: function (a) {
        a.wobble(), sounds.playPiano(), Config.USE_PARTICLES && this.vfx.explodeStars(a.getX(), a.getY())
    },
    touchInsideBounds: function (a, b) {
        var c = Config.TOUCH_BOUNDS.x,
            d = Config.TOUCH_BOUNDS.y,
            e = Config.TOUCH_BOUNDS.width,
            f = Config.TOUCH_BOUNDS.height;
        return a >= c && c + e >= a && b >= d && d + f >= b ? !0 : !1
    },
    fitPointInBounds: function (a, b) {
        var c = Config.TOUCH_BOUNDS.x,
            d = Config.TOUCH_BOUNDS.y,
            e = Config.TOUCH_BOUNDS.width,
            f = Config.TOUCH_BOUNDS.height;
        return c > a ? a = c : a > c + e && (a = c + e), d > b ? b = d : b > d + f && (b = d + f), {
            x: a,
            y: b
        }
    },
    startDrawingLine: function (a) {
        this.drawLine = new App.DrawLine(this.game, a, this.parentGroup)
    },
    touchUpHandler: function () {
        this.drawLine && this.drawLine.stopFollow()
    },
    getTapDotUnderPoint: function (a, b) {
        for (var c = 40, d = void 0, e = 0; e < this.dots.length; e++) {
            var f = this.dots[e],
                g = a - f.getX(),
                h = b - f.getY() - Config.offsetY,
                i = Math.sqrt(g * g + h * h);
            c >= i && (c = i, d = f);
        }
        return d
    },
    getNearestDotUnderPoint: function (a, b) {
        for (var c = 30, d = void 0, e = 0; e < this.dots.length; e++) {
            var f = this.dots[e];
            if (f != this.drawLine.dot) {
                var g = a - f.getX(),
                    h = b - f.getY(),
                    i = Math.sqrt(g * g + h * h);
                c >= i && (c = i, d = f)
            }
        }
        return d
    },
    getStaticLinkByDots: function (a, b) {
        for (var c = 0; c < this.staticLinks.length; c++) {
            var d = this.staticLinks[c];
            if (d.a1 === a && d.a2 === b || d.a1 === b && d.a2 === a) return d
        }
        return null
    },
    update: function () {
        if (!game.anwsering && this.drawLine && (this.drawLine.update(), this.drawLine.isFollowing())) {
            var a = this.game.input.activePointer.worldX,
                b = this.game.input.activePointer.worldY,
                c = this.getNearestDotUnderPoint(a, b);
            if (c) {
                var d = this.getStaticLinkByDots(this.drawLine.dot, c);
                if (d) {
                    if (d.isArrow)
                        if (this.drawLine.dot === d.a1) this.connectTwoDots(c, d);
                        else {
                            var e = this.fitPointInBounds(a, b);
                            this.drawLine.setEndPos(e.x, e.y)
                        }
                    else this.connectTwoDots(c, d);
                } else {
                    var e = this.fitPointInBounds(a, b);
                    this.drawLine.setEndPos(e.x, e.y)
                }
            } else {
                var e = this.fitPointInBounds(a, b);
                game.startDraw && this.drawLine.setEndPos(e.x, e.y)
            }
        }
    },
    connectTwoDots: function (a, b) {
        var c = new App.UserLink(this.game, this.linksGroup, this.drawLine.dot, a, b.isArrow);
        this.userLinks.push(c), this.partyDot(a), this.drawLine.destroy(), this.drawLine = null, this.removeStaticLink(b), 0 == this.staticLinks.length ? this.playerSolvedLevel() : this.startDrawingLine(a)
    },
    playerSolvedLevel: function () {
        sounds.play("sndLevelComplete"), this.game.input.onDown.remove(this.touchDownHandler, this), this.game.input.onUp.add(this.touchUpHandler, this), cmd.levelComplete()
    },
    undo: function () {
        if (this.userLinks.length > 0) {
            var a = this.userLinks.pop();
            this.addStaticLink(a.a1.id, a.a2.id, a.isArrow), this.drawLine.destroy(), this.startDrawingLine(a.a1), this.drawLine.stopFollow(), a.destroy()
        } else this.drawLine && (this.drawLine.destroy(), this.drawLine = null)
    },
    showAnwser: function () {
        var idx = 0;
        var dot = this.getDotById(data.curLevel.data.anwser[idx]);
        var link;
        this.partyDot(dot);
        this.startDrawingLine(dot);
        this.drawLine && this.drawLine.stopFollow();
        idx++;
        var timer = setInterval(() => {
            if (idx < data.curLevel.data.anwser.length) {
                dot = this.getDotById(data.curLevel.data.anwser[idx]);
                link = this.getStaticLinkByDots(this.drawLine.dot, dot);
                dot && link && this.connectTwoDots(dot, link);
            } else {
                game.anwsering = false;
                game.startDraw = false;
                this.drawLine && this.drawLine.stopFollow();
                clearInterval(timer);
            }
            idx++;
        }, 350);
    },
});
App.Level = Class.extend({
    init: function (a, b) {
        this.id = a, this.data = b, this.reset()
    },
    reset: function () {
        this.isCompleted = !1, this.isOpen = !1
    },
    complete: function () {
        this.isCompleted = !0
    },
    getTitle: function () {
        return this.data.name;
    }
});
App.Tier = Class.extend({
    init: function (a, b) {
        this.id = a, this.levelNum = b, this.reset();
    },
    reset: function () {
        this.isCompleted = !1, this.isOpen = !1;
        this.loaded = weixin.isLevelLoaded(this.id);
    },
    complete: function () {
        this.isCompleted = !0;
    },
    getTitle: function () {
        return this.levelNum;
    }
});
App.BitmapLine = Class.extend({
    init: function (a, b, c, d, e) {
        this.game = a, this.group = b, this.bitmapAsset = c, this.startX = d, this.startY = e, this.bmdGroup = new Phaser.Group(this.game, this.group), this.bmdGroup.x = this.startX, this.bmdGroup.y = this.startY
    },
    createDynamicBitmap: function () {
        this.bmdWidth = 800, this.bmdHeight = 18, this.bmd = this.game.add.bitmapData(this.bmdWidth, this.bmdHeight), this.game.add.sprite(0, -this.bmdHeight / 2, this.bmd, 0, this.bmdGroup)
    },
    createStaticBitmap: function (a, b) {
        var c = a - this.startX,
            d = b - this.startY,
            e = Math.round(Math.sqrt(c * c + d * d)),
            f = Math.atan2(d, c);
        this.bmdWidth = e, this.bmdHeight = 18, this.bmd = this.game.add.bitmapData(this.bmdWidth, this.bmdHeight), this.game.add.sprite(0, -this.bmdHeight / 2, this.bmd, 0, this.bmdGroup), this.bmdGroup.rotation = f, this.render(a, b)
    },
    render: function (a, b) {
        var c = a - this.startX,
            d = b - this.startY,
            e = Math.round(Math.sqrt(c * c + d * d));
        if (e > 2) {
            var f = Math.atan2(d, c);
            this.bmdGroup.rotation = f, this.bmd.clear();
            var g = new Phaser.Rectangle(0, 0, e, this.bmdHeight);
            this.bmd.copyRect(this.bitmapAsset, g, 0, 0);
        }
    }
});
App.CreditsView = App.Dialog.extend({
    init: function (a) {
        this._super(a, "creditsBox", {
            x: 147,
            y: 200,
            blockBack: !0
        }), this.closeBt = new App.MyButton(this.game, "closeButton", this.closeClick, this, {
            x: 335,
            y: 25,
            center: !0,
            parentGroup: this.boxHolder
        });
        var b = data.texts[data.lang].credits,
            c = a.add.text(173, 70, b, {
                font: "50px Fredericka the Great",
                fill: "#373572",
                align: "center"
            }, this.boxHolder);
        c.anchor.set(.5, .5), this.logoBt = new App.MyButton(this.game, "postepennoLogo", this.logoClick, this, {
            x: 13,
            y: 160,
            parentGroup: this.boxHolder
        });
        var d = data.texts[data.lang].credits_code;
        this.gameByTxt = new Phaser.Text(this.game, 125, 156, d, {
            font: "bold 18px Arial"
        }), this.boxHolder.add(this.gameByTxt);
        var e = data.texts[data.lang].credits_art;
        this.artTxt = new Phaser.Text(this.game, 125, 200, e, {
            font: "bold 18px Arial"
        }), this.boxHolder.add(this.artTxt)
    },
    closeClick: function () {
        this.destroy()
    },
    logoClick: function () {
        Play68.goHome();
    }
});
App.DeleteProgressView = App.Dialog.extend({
    init: function () {
        this._super(game, "clearProgressBox", {
            x: 147,
            y: 200,
            blockBack: !0
        });
        var a = data.texts[data.lang].clear_progress,
            b = game.add.text(173, 70, a, {
                font: "50px Fredericka the Great",
                fill: "#373572",
                align: "center"
            }, this.boxHolder);
        b.anchor.set(.5, .5), this.yesBt = new App.MyButton(this.game, "yesButton", this.yesClick, this, {
            x: 85,
            y: 245,
            center: !0,
            parentGroup: this.boxHolder
        }), this.noBt = new App.MyButton(this.game, "noButton", this.noClick, this, {
            x: 270,
            y: 245,
            center: !0,
            parentGroup: this.boxHolder
        })
    },
    yesClick: function () {
        cookies.clear(), this.destroy()
    },
    noClick: function () {
        this.destroy()
    }
});
App.Dot = Class.extend({
    init: function (a, b, c, d, e, f) {
        this.game = a, this.id = c, this.baseAssetName = f, this.group = new Phaser.Group(this.game, b), this.group.x = d, this.group.y = e, this.lastSprite = void 0, this.setState(App.Dot.BASE)
    },
    getX: function () {
        return this.group.x
    },
    getY: function () {
        return this.group.y;
    },
    setState: function (a) {
        this.state = a, this.sprite && this.sprite.destroy(), this.setSprite(this.baseAssetName)
    },
    setSprite: function (a) {
        this.sprite = data.addAtlasSprite(a, {
            parent: this.group
        }), this.sprite.pivot.x = .5 * this.sprite.width, this.sprite.pivot.y = .5 * this.sprite.height, this.group.addAt(this.sprite, 0)
    },
    setLast: function (a) {
        1 == a ? (this.lastSprite = new Phaser.Sprite(this.game, 0, 0, "dotLast"), this.lastSprite.anchor.set(.5, .5), this.group.add(this.lastSprite)) : 0 == a && this.lastSprite.destroy()
    },
    wobble: function () {
        util.wobble(this.group, 2)
    }
});
App.Dot.BASE = "AnchorBase", App.Dot.ACTIVE = "AnchorActive", App.Dot.VISITED = "AnchorVisited";
App.DrawLine = Class.extend({
    init: function (a, b, c) {
        this.game = a, this.followPointer = !1, this.dot = b, this.ex = this.dot.getX(), this.ey = this.dot.getY(), this.group = new Phaser.Group(this.game, c), Config.BITMAP_LINES ? (this.view = new App.BitmapLine(this.game, this.group, "drawLine", this.ex, this.ey), this.view.createDynamicBitmap()) : this.view = new App.GraphicLine(this.game, this.group, "0xFF0000", this.ex, this.ey);
        this.endSprite = data.addAtlasSprite("drawLineEnd", {
            parent: this.group
        }), this.endSprite.anchor.set(.5, .5), this.render(), this.startFollow()
    },
    setEndPos: function (a, b) {
        this.ex = a, this.ey = b, this.render()
    },
    render: function () {
        this.view.render(this.ex, this.ey), this.endSprite.x = this.ex, this.endSprite.y = this.ey
    },
    update: function () {
        this.endSprite.rotation += .1
    },
    startFollow: function () {
        this.followPointer = !0
    },
    stopFollow: function () {
        this.followPointer = !1
    },
    isFollowing: function () {
        return this.followPointer
    },
    destroy: function () {
        this.group.destroy()
    }
});
App.FPS = Class.extend({
    init: function (a, b) {
        this.game = a, this.parentGroup = b, this.game.time.advancedTiming = !0, this.fpsTxt = new Phaser.Text(this.game, 0, 0, "FPS: XXX", {
            font: "bold 20px " + weixin.fonts.bmjz,
            fill: "#FF0000"
        }), this.parentGroup.add(this.fpsTxt), this.update(), this.game.time.events.loop(Phaser.Timer.SECOND, this.update, this)
    },
    update: function () {
        this.fpsTxt.setText("FPS: " + this.game.time.fps);
    }
});
App.Fader = Class.extend({
    init: function (a) {
        this.game = a
    },
    fade: function (a, b) {
        this.callback = a, this.scope = b, this.pic = game.add.sprite(0, -Config.offsetY, "fader"), this.pic.alpha = 0, this.pic.inputEnabled = !0;
        var c = game.add.tween(this.pic).to({
            alpha: .8
        }, 300, Phaser.Easing.Linear.None, !0);
        c.onComplete.addOnce(this.fadeInComplete, this)
    },
    fadeInComplete: function () {
        App.Fader.SHOULD_FADE_OUT = !0, this.callback.call(this.scope)
    },
    fadeOut: function () {
        App.Fader.SHOULD_FADE_OUT = !1, this.pic = game.add.sprite(0, -Config.offsetY, "fader"), this.pic.inputEnabled = !0;
        var a = game.add.tween(this.pic).to({
            alpha: 0
        }, 300, Phaser.Easing.Linear.None, !0);
        a.onComplete.addOnce(this.fadeOutComplete, this)
    },
    fadeOutComplete: function () {
        this.pic.destroy()
    }
});
App.Fader.SHOULD_FADE_OUT = !1;
App.GraphicLine = Class.extend({
    init: function (a, b, c, d, e) {
        this.game = a, this.group = b, this.color = c, this.startX = d, this.startY = e, this.g = new Phaser.Graphics(this.game, 0, 0), this.group.add(this.g)
    },
    render: function (a, b) {
        this.g.clear(), this.g.lineStyle(5, this.color), this.g.moveTo(this.startX, this.startY), this.g.lineTo(a, b)
    }
});
App.LevelItem = Class.extend({
    init: function (a, b, c, d, e) {
        if (this.game = a, this.level = c, this.parentGroup = b, this.group = new Phaser.Group(this.game, this.parentGroup), this.group.x = d, this.group.y = e, c.isOpen) {
            var f, g = 0;
            c.isCompleted ? (f = "levelItemCompleteBack") : (f = "levelItemBack"), this.bt = new App.MyButton(this.game, f, this.click, this, {
                center: !0,
                parentGroup: this.group
            });
            var h = this.game.add.bitmapText(0, 0, "eras", (this.level.id + 1).toString(), 50, this.group);
            h.x = .5 * -h.textWidth - 6, h.y = .3 * -h.textHeight - 6
        } else {
            var i = data.addAtlasSprite("levelItemLockedBack", {
                x: 0,
                y: 0,
                parent: this.group
            });
            i.anchor.set(.5, .5)
        }
    },
    click: function () {
        util.wobble(this.group), fader.fade(this.go, this)
    },
    go: function () {
        cmd.levelStart(this.level.id)
    }
});
App.LevelsGroup = Class.extend({
    init: function (a, c) {
        this.game = a, this.parentGroup = c, this.group = new Phaser.Group(this.game, this.parentGroup), this.group.y = 0;
        var d = 106,
            e = 106;
        this.rows = 8, this.cols = 4, this.boundsRect = {
            x: 70,
            y: Config.realHeight / 2 - 460 - Config.offsetY,
            width: 500,
            height: 460 * 2
        };
        for (var f = this.rows * this.cols, g = (this.boundsRect.width - d) / (this.cols - 1), h = (this.boundsRect.height - e) / (this.rows - 1), i = 0, j = 1 * f, k = 0, l = i; j > l; l++) {
            var m = data.levels[l];
            if (m) {
                var n = this.boundsRect.x + d / 2 + k % this.cols * g,
                    o = this.boundsRect.y + e / 2 + Math.floor(k / this.cols) * h;
                new App.LevelItem(this.game, this.group, m, n, o)
            }
            k++
        }
    }
});
App.TierItem = Class.extend({
    init: function (a, b, c, d, e) {
        this.game = a, this.tier = c, this.parentGroup = b, this.group = new Phaser.Group(this.game, this.parentGroup), this.group.x = d, this.group.y = e;
        if (c.isOpen) {
            var f, g = 0;
            f = c.isCompleted ? "tier_complete" : "tier_current";
            this.bt = new App.MyButton(this.game, f, this.click, this, {
                center: !0,
                parentGroup: this.group,
                atlas: false,
            });
            var h = this.game.add.bitmapText(0, 0, "eras", (this.tier.id + 1).toString(), 50, this.group);
            h.x = .5 * -h.textWidth - 6, h.y = .3 * -h.textHeight - 6
        } else {
            var i = game.add.sprite(0, 0, "tier_lock", null, this.group);
            i.anchor.set(.5, .5)
        }
    },
    click: function () {
        util.wobble(this.group), fader.fade(this.go, this)
    },
    go: function () {
        cmd.tierSelect(this.tier.id)
    }
});
App.TiersGroup = Class.extend({
    init: function (a, c, b) {
        this.game = a, this.id = b, this.parentGroup = c, this.group = new Phaser.Group(this.game, this.parentGroup), this.group.y = this.id * (Config.realHeight);
        var d = 456, //to calculate
            e = 111;
        this.boundsRect = {
            x: 70,
            y: Config.realHeight / 2 - 460 - Config.offsetY,
            width: 500,
            height: 460 * 2
        };
        this.rows = App.TiersGroup.ROW, this.cols = App.TiersGroup.COL;
        for (var f = this.rows * this.cols, i = this.id * f, j = (this.id + 1) * f, k = 0, l = i; j > l; l++) {
            var m = data.tiers[l];
            var g = (this.boundsRect.width - d) / (this.cols + 1);
            var h = (this.boundsRect.height - e) / (this.rows - 1);
            if (m) {
                var n = this.boundsRect.x + d / 2 + (k % this.cols + 1) * g,
                    o = this.boundsRect.y + e / 2 + Math.floor(k / this.cols) * h;
                new App.TierItem(this.game, this.group, m, n, o);
            }
            k++
        }
    }
});
App.TiersGroup.ROW = 8;
App.TiersGroup.COL = 1;
App.MyButton = Class.extend({
    init: function (a, b, c, d, e) {
        this.game = a;
        var f = 0,
            g = 0;
        this.callback = c, this.callbackContext = d;
        var h = !1,
            i = a.world,
            j = !0;
        if (this.wobble = !1, e && (void 0 != e.x && (f = e.x), void 0 != e.y && (g = e.y), 1 == e.center && (h = !0), void 0 != e.parentGroup && (i = e.parentGroup), e.atlas === !1 && (j = !1), 1 == e.wobble && (this.wobble = !0)), j) {
            var k = data.getAtlasKey(b);
            this.bt = a.add.button(f, g, data.atlasName, this.clickHandler, this, k, k, k, k, i)
        } else this.bt = a.add.button(f, g, b, this.clickHandler, this, null, null, null, null, i);
        this.bt.input.useHandCursor = !0, h && this.bt.anchor.set(.5, .5)
    },
    clickHandler: function () {
        sounds.play("sndClick"), this.wobble && util.wobble(this.bt), this.callback.call(this.callbackContext)
    },
    scaleHide: function () {
        this.game.add.tween(this.bt.scale).to({
            x: 0,
            y: 0
        }, 200, Phaser.Easing.Linear.None, !0)
    },
    scaleShow: function () {
        this.game.add.tween(this.bt.scale).to({
            x: 1,
            y: 1
        }, 200, Phaser.Easing.Linear.None, !0)
    },
    hide: function () {
        this.bt.scale.x = this.bt.scale.y = 0
    },
    show: function () {
        this.bt.scale.x = this.bt.scale.y = 1
    },
    disableClick: function () {
        this.bt.inputEnabled = !1
    },
    enableClick: function () {
        this.bt.inputEnabled = !0
    }
});
App.Paper = Class.extend({
    init: function (a, b) {
        this.game = a, this.parentGroup = b
    },
    addDecor: function (a, b, c) {
        data.addAtlasSprite(a, {
            x: b,
            y: c,
            parent: this.parentGroup
        })
    }
});
App.PauseView = App.Dialog.extend({
    init: function (a) {
        this.parentState = a, this._super(game, "pauseBox", {
            x: (Config.WIDTH - 581)/2,
            y: 200,
            blockBack: !0
        });
        this.exitBt = new App.MyButton(this.game, "levelsButton", this.exitClick, this, {
            x: 210,
            y: 180,
            center: !0,
            parentGroup: this.boxHolder,
            wobble: !0
        }), this.nextBt = new App.MyButton(this.game, "nextButton", this.resumeClick, this, {
            x: 380,
            y: 180,
            center: !0,
            parentGroup: this.boxHolder
        }), this.startTime = game.time.now, data.pausedByUser = !0
    },
    exitClick: function () {
        data.pausedByUser = false;
        this.destroy();
    },
    gotoMenu: function () {
        game.state.start("LevelSelect");
    },
    resumeClick: function () {
        data.pausedByUser = false;
        weixin.share(function () {
            cmd.levelStart(data.curLevel.id);
            game.anwsering = true;
        });
        this.destroy()
    }
});
App.SoundIcon = Class.extend({
    init: function (a, b) {
        var c = 0,
            d = 0,
            e = 1,
            f = a.world;
        void 0 != b && (void 0 != b.x && (c = b.x), void 0 != b.y && (d = b.y), void 0 != b.scale && (e = b.scale), void 0 != b.parentGroup && (f = b.parentGroup)), this.group = a.add.group(f), this.group.x = c, this.group.y = d, this.group.scale.x = this.group.scale.y = e, this.btOn = new App.MyButton(a, "soundIconOn", this.sndClick, this, {
            center: !0,
            parentGroup: this.group
        }), this.btOff = new App.MyButton(a, "soundIconOff", this.sndClick, this, {
            center: !0,
            parentGroup: this.group
        }), this.updateIcon()
    },
    updateIcon: function () {
        Config.SOUNDS_ENABLED ? (this.btOn.show(), this.btOff.hide()) : (this.btOn.hide(), this.btOff.show())
    },
    hide: function () {
        this.group.visible = !1
    },
    sndClick: function () {
        Config.SOUNDS_ENABLED = !Config.SOUNDS_ENABLED, Config.SOUNDS_ENABLED ? sounds.startMusic() : sounds.stopMusic(), cookies.saveSound(), this.updateIcon(), util.wobble(this.group)
    },
    disableClick: function () {
        this.btOn.disableClick(), this.btOff.disableClick()
    }
});
App.StateSlider = Class.extend({
    init: function () {
        this.transitionTime = 1500, this.easingIn = Phaser.Easing.Cubic.In, this.easingOut = Phaser.Easing.Cubic.Out
    },
    levelComplete: function () {
        var a = data.curLevel.id,
            b = data.levels[a + 1];
        b ? this.slideToNextLevel(b) : cmd.tierComplete()
    },
    slideToNextLevel: function (a) {
        var b = game.state.getCurrentState().getCoreGroup();
        this.transitionGroup = new Phaser.Group(game, b), this.transitionGroup.x = Config.WIDTH, parser.generateLevel(game, this.transitionGroup, a);
        var c = new Phaser.Tween(game.camera, game, game.tweens);
        c.to({
            x: Config.WIDTH
        }, this.transitionTime, Phaser.Easing.Cubic.InOut), c.onComplete.addOnce(this.levelSlideComplete, this), c.start()
    },
    levelSlideComplete: function () {
        var a = data.curLevel.id + 1;
        cmd.levelStart(a)
    }
});
App.StaticLink = Class.extend({
    init: function (a, b, c, d, e) {
        this.game = a, this.a1 = c, this.a2 = d, this.isArrow = e, this.group = new Phaser.Group(this.game, b);
        var f = this.a1.getX(),
            g = this.a1.getY(),
            h = this.a2.getX(),
            i = this.a2.getY();
        if (Config.BITMAP_LINES ? (this.view = new App.BitmapLine(this.game, this.group, "staticLink", f, g), this.view.createStaticBitmap(h, i)) : (this.view = new App.GraphicLine(this.game, this.group, "0x999999", f, g), this.view.render(h, i)), this.isArrow) {
            var j = h - f,
                k = i - g,
                l = Math.atan2(k, j),
                m = data.addAtlasSprite("arrow", {
                    x: f + j / 2,
                    y: g + k / 2,
                    parent: this.group
                });
            m.anchor.set(.5, .5), m.rotation = l
        }
    },
    destroy: function () {
        this.group.destroy()
    }
});
App.Tutorial = Class.extend({
    init: function (a) {
        this.game = a;
        var b = Config.WIDTH / 2;
        if (0 == data.curLevel.id) {
            this.addText(data.texts[data.lang].tutorial1, {
                x: b,
                y: 80,
                delay: 500
            });
        } else if (16 == data.curLevel.id) {
            this.addText(data.texts[data.lang].tutorial3, {
                x: b,
                y: 150,
                delay: 500
            });
        }
    },
    addSprite: function (a, b, c) {
        var d = data.addAtlasSprite(a, {
            x: b,
            y: c - 10
        });
        d.alpha = 0, game.add.tween(d).to({
            alpha: 1,
            y: c
        }, 1e3, Phaser.Easing.Quadratic.Out, !0)
    },
    addText: function (a, b) {
        var c = 0,
            d = 0,
            e = 500,
            f = {
                font: "34px " + weixin.fonts.bmjz,
                fill: "#000000"
            };
        b && (void 0 != b.x && (c = b.x), void 0 != b.y && (d = b.y), void 0 != b.delay && (e = b.delay), void 0 != b.style && (f = b.style));
        var g = this.game.add.text(c, d, a, f);
        g.align = "center", g.anchor.set(.5, 0), g.alpha = 0, g.y -= 10, this.game.add.tween(g).delay(e).to({
            alpha: 1,
            y: d
        }, 1e3, Phaser.Easing.Quadratic.Out, !0)
    }
});
App.UserLink = Class.extend({
    init: function (a, b, c, d, e) {
        this.game = a, this.a1 = c, this.a2 = d, this.isArrow = e, this.group = new Phaser.Group(this.game, b);
        var f = this.a1.getX(),
            g = this.a1.getY(),
            h = this.a2.getX(),
            i = this.a2.getY();
        if (Config.BITMAP_LINES ? (this.view = new App.BitmapLine(this.game, this.group, "userLink", this.a1.getX(), this.a1.getY()), this.view.createStaticBitmap(d.getX(), d.getY())) : (this.view = new App.GraphicLine(this.game, this.group, "0x000000", this.a1.getX(), this.a1.getY()), this.view.render(this.a2.getX(), this.a2.getY())), this.isArrow) {
            var j = h - f,
                k = i - g,
                l = Math.atan2(k, j),
                m = data.addAtlasSprite("arrow", {
                    x: f + j / 2,
                    y: g + k / 2,
                    parent: this.group
                });
            m.anchor.set(.5, .5), m.rotation = l
        }
    },
    destroy: function () {
        this.group.destroy()
    }
});
App.VisualFX = Class.extend({
    init: function (a) {
        this.game = a, this.emitter = this.game.add.emitter(0, 0, 100);
        for (var b = [], c = 1; 4 >= c; c++) b.push("pics/starParticle" + c + "_0000");
        this.emitter.makeParticles("pics", b), this.emitter.gravity = 0, this.emitter.setAlpha(1, 0, 4e3), this.emitter.setScale(.3, 1.5, .3, 1.5, 2e3), this.emitter.forEach(this.tune, this, !1)
    },
    tune: function (a) {
        a.anchor.set(0, 0), a.pivot.x = .5 * a.width, a.pivot.y = .5 * a.height
    },
    explodeStars: function (a, b) {
        this.emitter.x = a, this.emitter.y = b, this.emitter.start(!0, 2e3, null, 5)
    }
});
App.LeaderBoard = Class.extend({
    init: function (a,b,c,d) {
        weixin.postMessage('SHOW_RANKING_LIST');
        let sharedCanvas = weixin.sharedCanvas;
        game.add.sprite(a,b, Phaser.XTexture(sharedCanvas,0,0,c||sharedCanvas.width,d||sharedCanvas.height));
    }
});
App.BootState = function () {};
App.BootState.prototype = {
    preload: function () {
        this.load.image("preloadBar", "assets/images/preloadBar.png"), this.load.image("preloadBarHolder", "assets/images/preloadBarHolder.png"), this.load.image("background", Config.backgroundPath), game.stage.backgroundColor = "#EBE7DA"
    },
    create: function () {
        this.game.input.maxPointers = 1, this.game.scale.scaleMode = Phaser.ScaleManager.SHOW_ALL, this.game.scale.pageAlignHorizontally = !0, this.game.scale.pageAlignVertically = !0, Config.TRANSPARENT && (this.game.world.alpha = .5), this.game.device.android && !this.game.device.chrome && (Config.BITMAP_LINES = !1, Config.USE_PARTICLES = !1), this.game.state.start("Preloader")
    },
    rescale: function () {}
};
App.GameCompleteState = function () {};
App.GameCompleteState.prototype = {
    create: function () {
        this.add.sprite(0, -Config.offsetY, "background");
        this.add.sprite(0, 0, "gameCompleteBack"), this.backBt = new App.MyButton(this.game, "homeButton", this.backClick, this, {
            x: 116,
            y: 740,
            center: !0,
            wobble: !0
        }), this.tweenAlphaButton(this.backBt.bt, 2e3), App.Fader.SHOULD_FADE_OUT && fader.fadeOut()
    },
    tweenAlphaButton: function (a, b) {
        a.alpha = 0, this.add.tween(a).to({
            alpha: 1
        }, 500, Phaser.Easing.Linear.None, !0, b)
    },
    backClick: function () {
        fader.fade(this.gotoMenu, this)
    },
    gotoMenu: function () {
        game.state.start("MainMenu")
    }
};
App.GameplayState = function () {};
App.GameplayState.prototype = {
    create: function () {
        this.coreGroup = new Phaser.Group(this.game, this.game.world);
        var a = parser.generateLevel(this.game, this.coreGroup, data.curLevel);
        this.logic = new App.GameLogic(this.game, this.coreGroup, a.dotsGroup, a.linksGroup, a.dots, a.staticLinks), this.uiGroup = new Phaser.Group(this.game, this.game.world), this.uiGroup.fixedToCamera = !0;
         this.restartBt = new App.MyButton(this.game, "restartButton", this.restartClick, this, {
            x: 454,
            y: 53 +  Config.bottom,
            center: !0,
            parentGroup: this.uiGroup
        }), this.pauseBt = new App.MyButton(this.game, "pauseButton", this.pauseClick, this, {
            x: 79,
            y: 53 +  Config.bottom,
            center: !0,
            parentGroup: this.uiGroup,
            wobble: !0
        }), this.undoBt = new App.MyButton(this.game, "undoButton", this.undoClick, this, {
            x: 572,
            y: 52 +  Config.bottom,
            center: !0,
            parentGroup: this.uiGroup,
            wobble: !0
        }), this.soundIcon = new App.SoundIcon(this.game, {
            x: 197,
            y: 52 +  Config.bottom,
            parentGroup: this.uiGroup
        }), Config.ENABLE_CHEAT && (this.cheatBt = new App.MyButton(this.game, "cheatButton", this.cheatClick, this, {
            x: 320,
            y: 56 +  Config.bottom,
            center: !0,
            parentGroup: this.uiGroup
        })), data.curLevel.data.anwser && (this.shareBt = new App.MyButton(this.game, "moreGamesButton", this.shareClick, this, {
            x: 320,
            y: 52 +  Config.bottom,
            center: !0,
            parentGroup: this.uiGroup,
            wobble: !0
        })), this.game.onPause.add(this.globalPauseOn, this), this.game.onResume.add(this.globalPauseOff, this), this.tutorial = new App.Tutorial(this.game), App.Fader.SHOULD_FADE_OUT && fader.fadeOut();
        this.showAd();
    },
    destroy: function () {
        game.bannerAd.destroy();
    },
    showAd: function () {
        if (game.bannerAd) {
            return;
        }
        var info = wx.getSystemInfoSync();
        let bannerAd = wx.createBannerAd({
            adUnitId: 'adunit-9d31e9bf24a7a342',
            style: {
                left: info.screenWidth * 0.05,
                top: info.screenHeight - info.screenWidth * 0.9 / 3.1,
                width: info.screenWidth * 0.9
            }
        })
        bannerAd.show();
        game.bannerAd = bannerAd;
    },
    cheatClick: function () {
        cmd.levelComplete()
    },
    undoClick: function () {
        this.logic.undo()
    },
    globalPauseOn: function () {
        this.globalPauseStart = game.time.now
    },
    globalPauseOff: function () {
        data.pausedByUser || (data.pauseTime += Math.round(game.time.now - this.globalPauseStart))
    },
    addTimerEvent: function () {
        this.timerEvent = this.game.time.events.loop(Phaser.Timer.SECOND, this.updateUI, this)
    },
    removeTimerEvent: function () {
        this.game.time.events.remove(this.timerEvent)
    },
    updateUI: function () {
        this.timer.setTime(data.getLevelTime())
    },
    levelComplete: function () {
        this.disableButtons()
    },
    disableButtons: function () {
        this.undoBt.disableClick(), this.soundIcon.disableClick(), this.restartBt.disableClick(), this.pauseBt.disableClick()
    },
    getCoreGroup: function () {
        return this.coreGroup
    },
    update: function () {
        this.logic.update()
    },
    shareClick: function () {
        this.removeTimerEvent(), this.pauseView = new App.PauseView(this);
    },
    restartClick: function () {
        cmd.levelStart(data.curLevel.id);
    },
    pauseClick: function () {
        game.state.start("LevelSelect");
    },
    resumeGame: function () {},
};
App.LevelSelectState = function () {};
App.LevelSelectState.prototype = {
    create: function () {
        if (!data.initLevels() || !cookies.initLevels()) {
            return;
        }
        this.add.sprite(0, -Config.offsetY, "background"), this.itemsHolder = new Phaser.Group(this.game, this.game.world);
        this.group = new App.LevelsGroup(this.game, this.itemsHolder)
        var b = data.texts[data.lang].select_level,
            c = game.add.text(Config.WIDTH / 2, this.group.boundsRect.y - 32 * Config.ratio, b, {
                font: "50px Fredericka the Great",
                fill: "#373572"
            });
        c.anchor.set(.5, .5), this.homeBt = new App.MyButton(this.game, "homeButton", this.homeClick, this, {
            x: 113,
            y: this.group.boundsRect.y + this.group.boundsRect.height + 28 * Config.ratio,
            center: !0,
            wobble: !0
        });
        this.itemsHolder.y = 0;
        App.Fader.SHOULD_FADE_OUT && fader.fadeOut();
    },
    homeClick: function () {
        fader.fade(this.goBack, this);
    },
    goBack: function () {
        this.game.state.start(Config.SHOWTIER ? "TierSelect" : "MainMenu");
    }
};
App.TierSelectState = function () {};
App.TierSelectState.prototype = {
    create: function () {
        this.add.sprite(0, -Config.offsetY, "background"), this.itemsHolder = new Phaser.Group(this.game, this.game.world);
        this.groupsNum = Math.ceil(data.tiers.length / App.TiersGroup.COL / App.TiersGroup.ROW);
        for (var a = 0; a < this.groupsNum; a++) {
            this.group = new App.TiersGroup(this.game, this.itemsHolder, a);
        }
        this.homeBt = new App.MyButton(this.game, "homeButton", this.homeClick, this, {
            x: 113,
            y: this.group.boundsRect.y + this.group.boundsRect.height + 28 * Config.ratio,
            center: !0,
            wobble: !0
        });
        this.scrollUp = new App.MyButton(this.game, "upButton", this.scrollUpClick, this, {
            x: 555,
            y: this.group.boundsRect.y + this.group.boundsRect.height + 30 * Config.ratio,
            center: !0
        }), this.scrollDown = new App.MyButton(this.game, "downButton", this.scrollDownClick, this, {
            x: 445,
            y: this.group.boundsRect.y + this.group.boundsRect.height + 30 * Config.ratio,
            center: !0
        });
        this.itemsHolder.y = -Config.realHeight * App.TierSelectState.CURRENT_GROUP_ID, 0 == App.TierSelectState.CURRENT_GROUP_ID ? this.scrollUp.hide() : App.TierSelectState.CURRENT_GROUP_ID == this.groupsNum - 1 && this.scrollDown.hide(), App.Fader.SHOULD_FADE_OUT && fader.fadeOut()
        Config.SHOWTIER || cmd.tierSelect(0);
    },
    scrollUpClick: function () {
        1 == App.TierSelectState.CURRENT_GROUP_ID && this.scrollUp.scaleHide(), App.TierSelectState.CURRENT_GROUP_ID == this.groupsNum - 1 && this.scrollDown.scaleShow(), App.TierSelectState.CURRENT_GROUP_ID--, this.scrollUp.disableClick(), this.scrollDown.disableClick();
        var a = this.game.add.tween(this.itemsHolder);
        a.to({
            y: -Config.realHeight * App.TierSelectState.CURRENT_GROUP_ID
        }, 500, Phaser.Easing.Quadratic.InOut, !0), a.onComplete.addOnce(this.scrollComplete, this)
    },
    scrollDownClick: function () {
        0 == App.TierSelectState.CURRENT_GROUP_ID && this.scrollUp.scaleShow(), App.TierSelectState.CURRENT_GROUP_ID == this.groupsNum - 2 && this.scrollDown.scaleHide(), App.TierSelectState.CURRENT_GROUP_ID++, this.scrollUp.disableClick(), this.scrollDown.disableClick();
        var a = this.game.add.tween(this.itemsHolder);
        a.to({
            y: -Config.realHeight * App.TierSelectState.CURRENT_GROUP_ID
        }, 500, Phaser.Easing.Quadratic.InOut, !0), a.onComplete.addOnce(this.scrollComplete, this)
    },
    scrollComplete: function () {
        this.scrollUp.enableClick(), this.scrollDown.enableClick()
    },
    homeClick: function () {
        fader.fade(this.gotoMainMenu, this)
    },
    gotoMainMenu: function () {
        this.game.state.start("MainMenu");
    }
};
App.TierSelectState.CURRENT_GROUP_ID = 0;
App.MainMenuState = function () {};
App.MainMenuState.prototype = {
    create: function () {
        this.add.sprite(0, -Config.offsetY, "background");
        this.title = data.addAtlasSprite("gameTitle", {
            x: 250,
            y: 19
        });
        this.playBt = new App.MyButton(this.game, "playButton2", this.playClick, this, {
            x: 290,
            y: Config.iphonex ? 560 : 410,
            center: !0
        });
        util.pulse(this.playBt.bt, 1.1), this.character = data.addAtlasSprite("menuCharacter", {
            x: 264,
            y: Config.iphonex ? 630 : 481
        });
        this.soundIcon = new App.SoundIcon(this.game, {
            x: 65,
            y: 80 - Config.offsetY
        });
        this.shareBt = new App.MyButton(this.game, "shareButton", this.shareClick, this, {
            x: Config.WIDTH / 2,
            y: Config.realHeight - 100 - Config.offsetY,
            center: !0,
            wobble: !0,
            atlas: false,
        });
        this.deleteProgressBt = new App.MyButton(this.game, "clearProgressButton", this.deleteProgressClick, this, {
            x: 554,
            y: 638,
            center: !0,
            wobble: !0
        });
        this.creditsBt = new App.MyButton(this.game, "creditsButton", this.creditsClick, this, {
            x: 438,
            y: 638,
            center: !0,
            wobble: !0
        });
        this.moreGames = new App.MyButton(this.game, "moreGamesButton", this.moreGamesClick, this, {
            x: 320,
            y: 638,
            center: !0,
            wobble: !0
        });
        this.creditsBt.bt.visible = !1;
        this.moreGames.bt.visible = !1;
        this.deleteProgressBt.bt.visible = !1;
        this.showWithTweens(), App.Fader.SHOULD_FADE_OUT && fader.fadeOut();
        /* this.leaderBoard = new App.LeaderBoard(0, 0); */
    },
    update: function () {
    },
    moreGamesClick: function () {},
    showWithTweens: function () {
        this.title.alpha = 0, this.add.tween(this.title).to({
            alpha: 1
        }, 800, Phaser.Easing.Linear.None, !0), this.character.alpha = 0, this.add.tween(this.character).to({
            alpha: 1
        }, 800, Phaser.Easing.Linear.None, !0, 500), this.tweenScaleButton(this.soundIcon.group, 1300), this.tweenScaleButton(this.moreGames.bt, 1500), this.tweenScaleButton(this.creditsBt.bt, 1700), this.tweenScaleButton(this.deleteProgressBt.bt, 1900), this.tweenAlphaButton(this.playBt.bt, 2100)
    },
    tweenScaleButton: function (a, b) {
        a.scale.x = a.scale.y = 0, this.add.tween(a.scale).to({
            x: 1,
            y: 1
        }, 500, Phaser.Easing.Back.Out, !0, b)
    },
    tweenAlphaButton: function (a, b) {
        a.alpha = 0, this.add.tween(a).to({
            alpha: 1
        }, 500, Phaser.Easing.Linear.None, !0, b)
    },
    playClick: function () {
        fader.fade(this.startGame, this)
    },
    startGame: function () {
        cmd.gameStart()
    },
    deleteProgressClick: function () {
        new App.DeleteProgressView(this.game)
    },
    creditsClick: function () {
        new App.CreditsView(this.game)
    },
    shareClick: function () {
        weixin.share();
    }
};
App.PreloaderState = function () {};
App.PreloaderState.prototype = {
    preload: function () {
        this.add.sprite(0, -Config.offsetY, "background");
        var a, b = ["fader", "blackBack", "staticLink", "userLink", "drawLine", "pauseBox", "gameCompleteBack", 'tier_complete', 'tier_current', 'tier_lock', 'shareButton', ],
            c = ["sndClick", "sndLevelComplete", "music"];
        for (a = 0; a < b.length; a++) {
            var d = -1 == b[a].indexOf(".jpg") ? b[a] + ".png" : b[a];
            this.load.image(b[a], "assets/images/" + d);
        }
        if (Config.SOUNDS_ENABLED) {
            Config.PIANO && c.push('sndPiano');
            for (a = 0; a < c.length; a++) {
                this.load.audio(c[a], Config.cdnUrl + "/assets/sounds/" + c[a] + ".mp3?v=" + Math.random());
            }
        }
        this.load.atlasJSONHash("pics", "assets/images/pics.png", null, weixin.readFile('assets/images/pics.json'));
        this.load.bitmapFont("eras", "assets/fonts/eras.png", null, weixin.readFile('assets/fonts/eras.txt', 'txt'));
    },
    fileLoaded: function (a) {
        this.progressTxt.setText(a + "%");
    },
    create: function () {
        this.preloaderComplete();
    },
    preloaderComplete: function () {
        var a = 'en';
        fader = new App.Fader(this.game), cmd = new App.Commands, data = new App.Data(a), cookies = new App.Cookies, sounds = new App.Sounds, sounds.startMusic(), stateSlider = new App.StateSlider, parser = new App.Parser, util = new App.Util;
        this.game.state.start("MainMenu");
    }
};
var startup = function () {
    weixin.init();
    var width = Config.WIDTH;
    var height;
    Config.ratio = canvas.height / canvas.width;
    height = width * Config.ratio;
    if (Math.abs(Config.ratio - 16 / 9) > 0.01) {
        Config.offsetY = 300 / (812 / 375) * Config.ratio;
        Config.backgroundPath = "assets/images/background_iphonex.jpg";
        Config.iphonex = true;
        Config.bottom = (Config.WIDTH * Config.ratio - Config.HEIGHT) / 4;
        Config.levelY = 70;
    } else {
        Config.offsetY = 200;
        Config.backgroundPath = "assets/images/background.jpg";
        Config.iphonex = false;
        Config.bottom = 100;
        Config.levelY = -15;
    }
    Config.realHeight = height;
    Config.padding = (Config.realHeight - Config.HEIGHT) / 2;
    Config.TOUCH_BOUNDS.height = height;
    window.game = game = new Phaser.Game({
        width: width,
        height: height,
        renderer: Phaser.CANVAS,
        canvas: canvas
    });
    game.state.start = function () {
        game.bannerAd && (game.bannerAd.destroy(), game.bannerAd = null);
        game.world && game.world.setBounds(0, -Config.offsetY, game.world.width, game.world.height);
        game.state.__proto__.start.bind(game.state)(...arguments);
    };
    game.state.add("Boot", App.BootState), game.state.add("Preloader", App.PreloaderState), game.state.add("MainMenu", App.MainMenuState), game.state.add("LevelSelect", App.LevelSelectState), game.state.add("TierSelect", App.TierSelectState), game.state.add("Gameplay", App.GameplayState), game.state.add("GameComplete", App.GameCompleteState), game.state.start("Boot");
};
startup();